#!/usr/bin/env python3
import argparse
import importlib
from pymongo import MongoClient
from ukupacha.Graph import UkuPachaGraph
from ukupacha.Utils import replace_graph_db_field
from kaypacha.filters.scienti_filter import scienti_filter

parser = argparse.ArgumentParser(description='Oracle to MongoDB')
parser.add_argument('--max_threads', type=int, default=2,
                    help='an integer for number of threads, max threads 2')
parser.add_argument('--ora_sysuser', type=str,
                    default="system", help='Oracle System user')
parser.add_argument('--ora_syspass', type=str,
                    default="colavudea", help='Oracle System user password')
parser.add_argument('--ora_dburi', type=str, default="localhost:1521",
                    help='Oracle System db url default(localhost:1521)')
parser.add_argument('--model_year', required=True, type=str,
                    help='ukupacha data model ex: 2018')
parser.add_argument('--cvlac_user', type=str,
                    default='UDEA_CV', help='user for CVLAC')
parser.add_argument('--gruplac_user', type=str,
                    default='UDEA_GR', help='user for GRUPLAC')
parser.add_argument('--institulac_user', type=str,
                    default='UDEA_IN', help='user for INSTITULAC')
parser.add_argument('--mongo_dburi', type=str,
                    default='mongodb://localhost:27017/', help='uri for MongoDb database')
parser.add_argument('--mongo_dbname', type=str,
                    default=None, help='uri for MongoDb database')
parser.add_argument('--drop_mongodb', action='store_true', help='uri for MongoDb database')
parser.add_argument('--model', type=str,
                    default=None, help='data model ex: product, network, project etc..')
parser.add_argument('--sample', action='store_true',
                    help='process data sample')
parser.add_argument('--sample_size', type=int,
                    default=100,help='size of the sample')
parser.add_argument('--json', type=str,
                    help='save results to json file')
parser.add_argument('--json_save_regs', action='store_true',
                    help='save regs results to json file. but it works only if --json is enabled')



if __name__ == '__main__':
    args = parser.parse_args()
    print(args)
    #import sys
    #sys.exit(0)
    ora_graph = UkuPachaGraph(user=args.ora_sysuser,
                              password=args.ora_syspass, dburi=args.ora_dburi)

    model = args.model
    model_year = args.model_year
    mongo_dbname = args.mongo_dbname
    if not mongo_dbname:
        mongo_dbname = f"scienti_{model_year}"
    graph_schema = importlib.import_module(
        f'kaypacha.models.scienti.{model_year}.graph_schema').graph_schema
    graph_fields = importlib.import_module(
        f'kaypacha.models.scienti.{model_year}.graph_fields').graph_fields

    graph_schema = replace_graph_db_field(
        graph_schema, "__CVLAC__", args.cvlac_user)
    graph_schema = replace_graph_db_field(
        graph_schema, "__GRUPLAC__", args.gruplac_user)
    graph_schema = replace_graph_db_field(
        graph_schema, "__INSTITULAC__", args.institulac_user)
    max_threads = args.max_threads

    if max_threads > 2:
        print("max_threads can't be greater than 2 (https://www.oracle.com/database/technologies/appdev/xe.html)")
        print("setting max_threads=2")
        max_threads = 2
    if args.drop_mongodb:
        client = MongoClient(args.mongo_dburi)
        client.drop_database(mongo_dbname)
        client.close()

    if args.model:
        model = graph_schema["MODELS"][args.model]
        main_table = model["MAIN_TABLE"]
        graph = model["GRAPH"]
        query = f"select * from {args.cvlac_user}.{main_table}"
        if args.sample:
            query = f"select * from {args.cvlac_user}.{main_table} FETCH FIRST {args.sample_size} ROWS ONLY"
        data = ora_graph.utils.request(query)
        print(f"Processing database for model {main_table} with {data.shape[0]} registers.")
        if args.json:
            ora_graph.run2file(args.json,data,model,graph_fields[main_table],max_threads, debug=False, save_regs=False, save_raws=False, filter_function=scienti_filter)
        else:
            ora_graph.run2mongodb(data, model, graph_fields[main_table],
                              mongo_dbname, args.mongo_dburi, max_threads,scienti_filter)
    else:
        for model_name in graph_schema["MODELS"].keys():
            model = graph_schema["MODELS"][model_name]
            main_table = model["MAIN_TABLE"]
            graph = model["GRAPH"]

            query = f"select * from {args.cvlac_user}.{main_table}"
            if args.sample:
                query = f"select * from {args.cvlac_user}.{main_table} FETCH FIRST {args.sample_size} ROWS ONLY"
            data = ora_graph.utils.request(query)
            print(f"Processing database for model {main_table} with {data.shape[0]} registers.")
            # ora_graph.run2file("scienti.json",data,graph_base,graph_fields)
            if args.json:
                ora_graph.run2file(args.json,data,model,graph_fields[main_table],max_threads, debug=False, save_regs=False, save_raws=False, filter_function=scienti_filter)
            else:
                ora_graph.run2mongodb(data, model, graph_fields[main_table],
                                mongo_dbname, args.mongo_dburi, max_threads,scienti_filter)
